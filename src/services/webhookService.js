const driveServiceJWT = require('./driveServiceJWT');
const calendarServiceJWT = require('./calendarServiceJWT');
const userService = require('./userService');
const userModel = require('../models/userModel');
const logModel = require('../models/logModel');
const cron = require('node-cron');

// Renovar webhooks automaticamente (Drive e Calendar)
exports.renovarWebhooksAutomaticamente = async () => {
  try {
    console.log('üîÑ Iniciando renova√ß√£o autom√°tica de webhooks...');
    
    const webhookUrl = process.env.WEBHOOK_URL;
    if (!webhookUrl) {
      throw new Error('WEBHOOK_URL n√£o configurada no ambiente');
    }

    const usuarios = await userModel.getAllUsers();
    console.log(`üìã Processando ${usuarios.length} usu√°rios...`);

    let sucessos = 0;
    let erros = 0;

    for (const usuario of usuarios) {
      try {
        console.log(`üîÑ Renovando webhooks para: ${usuario.email}`);

        // Renovar webhook do Drive
        const driveResult = await driveServiceJWT.registrarWebhookDriveJWT(
          usuario.email, 
          `${webhookUrl}/drive`
        );
        
        // Salvar canal do Drive
        if (driveResult.resourceId) {
          await userModel.saveDrivePageToken(
            usuario.email, 
            driveResult.resourceId, 
            driveResult.id, 
            driveResult.startPageToken || null
          );
        }

        // Renovar webhook do Calendar (primary calendar)
        try {
          const calendarResult = await calendarServiceJWT.registrarWebhookCalendarJWT(
            usuario.email, 
            `${webhookUrl}/calendar`
          );
          
          // Salvar canal do Calendar
          if (calendarResult.resourceId) {
            await userModel.saveCalendarChannel(
              usuario.email, 
              calendarResult.resourceId, 
              calendarResult.id, 
              'primary'
            );
          }
        } catch (calendarError) {
          console.warn(`‚ö†Ô∏è Erro ao configurar webhook do Calendar:`, calendarError.message);
        }

        sucessos++;
        console.log(`‚úÖ Webhooks renovados para: ${usuario.email}`);
        
        // Pequena pausa para n√£o sobrecarregar a API
        await new Promise(resolve => setTimeout(resolve, 1000));
        
      } catch (error) {
        erros++;
        console.error(`‚ùå Erro ao renovar webhooks para ${usuario.email}:`, error.message);
      }
    }

    console.log(`üéâ Renova√ß√£o conclu√≠da: ${sucessos} sucessos, ${erros} erros`);
    return { sucessos, erros };
  } catch (error) {
    console.error('‚ùå Erro geral na renova√ß√£o de webhooks:', error);
    throw error;
  }
};

// For√ßar renova√ß√£o manual de webhooks
exports.forcarRenovacaoWebhooks = async () => {
  try {
    console.log('For√ßando renova√ß√£o manual de webhooks...');
    return await exports.renovarWebhooksAutomaticamente();
  } catch (error) {
    console.error('Erro na renova√ß√£o manual de webhooks:', error);
    throw error;
  }
};

// Verificar status dos webhooks
exports.verificarStatusWebhooks = async () => {
  try {
    const usuarios = await userService.getAllUsers();
    const status = [];

    for (const usuario of usuarios) {
      status.push({
        email: usuario.email,
        nome: usuario.nome,
        ativo: usuario.ativo,
        ultima_sincronizacao: usuario.ultima_sincronizacao,
        webhook_drive: 'Ativo',
        webhook_calendar: 'Ativo'
      });
    }

    return status;
  } catch (error) {
    console.error('Erro ao verificar status dos webhooks:', error);
    throw error;
  }
};

// Fun√ß√£o para iniciar agendamento (removida do carregamento autom√°tico)
exports.startWebhookRenewalScheduler = () => {
  // Agendamento autom√°tico de renova√ß√£o de webhooks a cada 6 dias
  cron.schedule('0 2 */6 * *', async () => {
    console.log('‚è∞ Iniciando renova√ß√£o autom√°tica de webhooks (agendado)...');
    try {
      await exports.renovarWebhooksAutomaticamente();
    } catch (error) {
      console.error('Erro na renova√ß√£o autom√°tica agendada:', error.message);
    }
  }, {
    scheduled: true,
    timezone: 'America/Sao_Paulo'
  });
  
  console.log('üîÑ Agendamento de renova√ß√£o de webhooks configurado (a cada 6 dias √†s 2h)');
}; 